---
description: Dynamic rule system - auto-generated rules from monitor daemon
globs: .cursor/rules/*.mdc, supernal-code-package/src/monitor/rules/**/*
alwaysApply: true
---

# Dynamic Rule System

## Overview

The monitor daemon automatically generates dynamic `.cursor/rules/*.mdc` files to provide real-time repository state awareness to AI agents.

## Dynamic Rules (Auto-Generated)

### `agent-state.mdc`
**Updates**: Every 30 seconds  
**Purpose**: Repository health and file management

**Provides**:
- Untracked files count
- Modified files count
- WIP-tracked files count
- Policy violations (üö® CRITICAL warnings)
- Sample untracked files
- Actionable recommendations

**Example**:
```
## üö® CRITICAL: Policy Violations
- üö® **CRITICAL**: 16 untracked files (threshold: 5)
- üö® **URGENT**: 14 files need immediate attention

**IMMEDIATE ACTION REQUIRED**:
1. **Commit ready files**: `git add <files> && git commit`
2. **WIP-track in-progress**: `sc workflow wip register <file> --feature=<name>`
```

### `feature-state.mdc`
**Updates**: Every 60 seconds  
**Purpose**: Track active work (committed + uncommitted)

**Provides**:
- Active features (with `feat(name):` commits)
- Commit count per feature
- Linked requirements (REQ-XXX)
- WIP files grouped by feature
- Features needing attention (10+ commits)

**Example**:
```
## Active Features
- **auth**: 12 commits (REQ-WORKFLOW-042)
- **dashboard**: 4 commits

## WIP Files (Uncommitted)
- **auth** (3 files):
  - `src/auth/login.ts`
```

## ‚úÖ DO: Work With Dynamic Rules

- **Read them for context**: AI agents see current repository state
- **Respect warnings**: üö® CRITICAL violations need immediate action
- **Use recommendations**: Follow suggested actions (commit, WIP-track, gitignore)
- **Understand WIP types**:
  - **WIP Files**: Uncommitted (in `.supernal/wip-registry.yaml`)
  - **Active Features**: Committed but in-progress (`feat(name):` tags)

## ‚ùå DON'T: Manual Editing

- **Never edit dynamic rules manually** - they are regenerated automatically
- **Don't commit them** - they're in `.gitignore`
- **Don't reference them in code** - they're for AI awareness only

## Implementation

**Location**: `supernal-code-package/src/monitor/rules/`

**Classes**:
- `RuleWriter` - Abstract base class
- `StateRuleWriter` - Generates `agent-state.mdc`
- `FeatureStateRuleWriter` - Generates `feature-state.mdc`
- `RuleWriterManager` - Orchestrates all writers

**Auto-registration**:
```typescript
// In RuleWriterManager constructor:
this.registerWriter('state', new StateRuleWriter(projectRoot));
this.registerWriter('features', new FeatureStateRuleWriter(projectRoot));
```

**Lifecycle**:
1. Daemon starts (`sc monitor start`)
2. `MonitorRunner.start()` calls `ruleManager.updateAll()`
3. Each writer generates its rule file
4. Scheduled updates continue automatically

## Gitignore

Dynamic rules are automatically added to `.gitignore`:
```
# Dynamic rules (generated by monitor daemon, never commit)
.cursor/rules/agent-state.mdc
.cursor/rules/feature-state.mdc
```

## Creating New Dynamic Rules

**Pattern**:
1. Create new `XxxRuleWriter` extending `RuleWriter`
2. Implement `gatherData()` - collect repository state
3. Implement `renderTemplate()` - generate markdown
4. Register in `RuleWriterManager` constructor
5. Add to `.gitignore`

**Example**:
```typescript
export class MyRuleWriter extends RuleWriter<MyData> {
  constructor(projectRoot: string) {
    super(projectRoot, {
      filename: 'my-rule.mdc',
      title: 'My Dynamic Rule',
      description: 'Tracks XYZ',
      gitignore: true,
      updateInterval: 30000 // 30 seconds
    });
  }
  
  protected async gatherData(): Promise<MyData> {
    // Collect data from git, filesystem, etc.
  }
  
  protected async renderTemplate(data: MyData): Promise<string> {
    return this.renderFromSections({
      sections: [...],
      frontmatter: {
        description: 'Short description',
        alwaysApply: true
      }
    });
  }
}
```

## Related

- [wip-registry.mdc](.cursor/rules/wip-registry.mdc) - WIP file tracking system
- [feature-management.mdc](.cursor/rules/feature-management.mdc) - Feature-based commits
- REQ-WORKFLOW-137 - Dynamic rule writer system

## Status

‚úÖ **Active** - Two dynamic rules running:
- `agent-state.mdc` (30s updates)
- `feature-state.mdc` (60s updates)

Both auto-register when daemon starts.
